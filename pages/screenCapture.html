<!DOCTYPE html>
<html>
	<head>
		<link href="../assets/styles/normalize.css"  rel="stylesheet" type="text/css"/>
		<script src="../assets/js/getScreenId.js"></script>
		<script src="../assets/js/jquery-3.1.1.min.js"></script>
		<title>Screen capture</title>
		<style>
			.main {
				width: 100%;
				height: 100vh;
				background-color: #4caf50;
			}
		</style>
	</head>
	<body class="main">
		<h3>Screen capture test</h3>
		<button onclick="handleCaptureScreen()">Capture screen</button>
		<button onclick="handleCaptureWebcam()">Capture webcam</button>
		<button onclick="handleCaptureAll()">Capture all</button>
		<video id="screen" width="500" autoplay>
			Your browser is not support video tag
		</video>
		<video id="webcam" width="500" autoplay>
			Your browser is not support video tag
		</video>
		<script>
			var localStream;
			window.localStream = localStream;
			var videoScreenTag = document.getElementById('screen');
			var videoWebcamTag = document.getElementById('webcam');
			function handleCaptureScreen() {
				console.log('handleCaptureScreen');
				getScreenId(function (error, sourceId, screen_constraints) {
					// error    == null || 'permission-denied' || 'not-installed' || 'installed-disabled' || 'not-chrome'
					// sourceId == null || 'string' || 'firefox'
					// screen_constraints.audio = true;
					console.log('error', error);
					console.log('sourceId', sourceId);
					console.log('screen_constraints');
					console.log(screen_constraints);
					navigator.getUserMedia = navigator.mozGetUserMedia || navigator.webkitGetUserMedia;
					navigator.getUserMedia(screen_constraints, function (stream) {
						videoScreenTag.src = URL.createObjectURL(stream);
						videoScreenTag.play();
						localStream = stream;
					}, function (error) {
						console.error(error);
					});
				});
			}
			function handleCaptureWebcam() {
				navigator.getUserMedia = navigator.mozGetUserMedia || navigator.webkitGetUserMedia;
				navigator.getUserMedia({audio: true, video: true}, function(stream) {
					// Set your video displays
					videoWebcamTag.src = URL.createObjectURL(stream);
					videoWebcamTag.play();
					localStream = stream;
				}, function () {
					alert('Have error when getUserMedia');
				});
			}
			function handleCaptureAll() {
				navigator.getUserMedia = navigator.mozGetUserMedia || navigator.webkitGetUserMedia;
				navigator.getUserMedia({audio: true, video: true}, function(stream) {
					getScreenId(function (error, sourceId, screen_constraints) {
						navigator.getUserMedia(screen_constraints, function (screenStream) {
							stream.addTrack(screenStream.getVideoTracks()[0]);
							localStream = stream;

							// Push the stream to video tags
							if(stream.getVideoTracks()[1]) {
								var videoTracks = [stream.getVideoTracks()[1]];
								var screenTracks = [];
								screenTracks = screenTracks.concat(videoTracks);
								var screenMediaStream = window.screenMediaStream = new MediaStream(screenTracks);

								videoWebcamTag.src = URL.createObjectURL(stream);
								videoWebcamTag.play();


								videoScreenTag.src = URL.createObjectURL(screenMediaStream);
								videoScreenTag.play();
							} else {
								console.log('Have only one video track');
							}
						}, function (error) {
							console.error(error);
						});
					});
				}, function (err) {
					alert('Have error when getUserMedia');
					console.log(err);
				});
			}
		</script>
	</body>
</html>
